Redis的高性能是由于将数据存储在内存中，为了保证数据不丢失，需要将数据从内存中同步到硬盘。这一过程就是持久化。

redis支持两种方式进行持久化

- RDB方式
- AOF方式
- 可以单独使用或两者结合使用

# RDB持久化

redis默认支持的持久化，无需配置

这种方式是在指定时间间隔内，将当前内存中的数据集快照写入磁盘。**注重的是数据的最终结果**。

## 优势

- 数据文件只有一个，对于备份和恢复数据库比较方便
- 相对于AOF，如果数据集很大，RDB的启动效率会更高

## 劣势

- 数据有可能会丢失。如果服务在两次快照之间崩溃了，那么从上一次快照到服务崩溃期间的数据就丢失了。
- 当数据量大时，持久化可能会导致服务器停止服务几百秒，甚至1秒。

## 配置

在redis.conf文件中进行配置

### 快照参数设置

```
save 900 1  #每900秒至少有1个key发生变化，则进行持久化
save 300 10 #每300秒至少有10个key发生变化，则进行持久化
save 60 10000   #每60秒至少有10000个key发生变化，则进行持久化
```

### 保存位置设置

```
# The filename where to dump the DB
dbfilename dump.rdb

# The working directory.
dir ./
```

# AOF持久化

这种方式是以日志的形式记录服务器的每一写操作。**注重的是过程**。

## 优势

- 数据安全性高。redis提供了3种同步策略
    + 每秒同步。同步是异步完成的，其效率非常高，所差的是一旦崩溃了，那么这一秒的修改就会丢失。
    + 每修改同步。可以视为同步持久化，一旦数据发生修改，立即存储到硬盘，这种效率上是最低的。
    + 不同步。
- 由于日志文件写入操作是append模式，如果在写入过程中系统崩溃了，可能会破坏日志文件已存在的内容。然而，如果本次操作只写入了一半数据就崩溃了，在下次启动前，可以通过redis-check-aof工具来解决一致性问题
- 如果日志文件过大，redis会自动启用rewrite机制。及redis以append模式不断写入到旧文件中，同时还会创建一个新的文件用于记录此期间的操作。因此进行rewrite切换时可以更好的保证数据安全性

## 劣势

- 对于相同数量的数据，AOF文件通常大于RDB文件
- 根据同步策略的不同，AOF在运行效率上往往会慢于RDB

## 配置

### 开启AOF

```
appendonly no   # 默认关闭，改为yes开启

appendfilename "appendonly.aof" # 文件名配置，目录与RDB一致
```

### 同步策略配置
```
# appendfsync always    #每修改同步
appendfsync everysec    #每秒同步，默认使用这种
# appendfsync no    #不同步
```

**如果开启了AOF方式，重启redis时，数据都会通过aof文件加载**