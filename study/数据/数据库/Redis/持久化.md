Redis的高性能是由于将数据存储在内存中，为了保证数据不丢失，需要将数据从内存中同步到硬盘。这一过程就是持久化。

redis支持两种方式进行持久化

- RDB方式
- AOF方式
- 可以单独使用或两者结合使用

# RDB持久化

redis默认支持的持久化，无需配置

这种方式是在指定时间间隔内，将当前内存中的数据集快照写入磁盘。**注重的是数据的最终结果**。

## 配置

在redis.conf文件中进行配置

### 快照参数设置

快照条件由两个参数构成：时间和改动键的个数。当在指定时间内改变的键的个数大于指定个数时，会进行快照。

以下是redis的默认配置：

```
save 900 1  #每900秒至少有1个key发生变化，则进行持久化
save 300 10 #每300秒至少有10个key发生变化，则进行持久化
save 60 10000   #每60秒至少有10000个key发生变化，则进行持久化
```

### rdb文件保存位置设置

```
# The filename where to dump the DB
dbfilename dump.rdb

# The working directory.
dir ./
```

## 数据恢复过程

redis启动后会读取RDB快照文件，将数据从硬盘载入到内存。

一般情况下，1GB的快照文件载入内存需要约20~30秒（不同服务器会有差异）。

## 快照过程

1. redis使用fork函数复制一份当前进程（父进程）的副本（子进程）
2. 父进程继续接收并处理客户端的请求，而子进程开始将内存中的数据写入到硬盘中的临时文件
3. 当子进程写入完所有数据后，会用该临时文件替换旧的RDB文件

## 优势

- 数据文件只有一个，对于备份和恢复数据库比较方便
- 相对于AOF，如果数据集很大，RDB的启动效率会更高

## 劣势

- 数据有可能会丢失。如果服务在两次快照之间崩溃了，那么从上一次快照到服务崩溃期间的数据就丢失了。
- 当数据量大时，持久化可能会导致服务器停止服务几百秒，甚至1秒。

## 手动快照

redis可以通过两个命令进行手动快照

- save 主进程进行快照，会阻塞其他请求
- bgsave 通过fork子进程进行快照

## rdb文件压缩

redis默认是开启压缩的，可以通过`rdbcompression`参数来指定是否需要压缩。

压缩：

  - 优点：减少硬盘存储空间
  - 缺点：消耗CPU资源

不压缩：

  - 优点：不消耗CPU资源
  - 缺点：占用硬盘空间多

## 注意

由于快照是通过fork来将当前进程复制一份的，那么子进程会与主进程占用相同量的内存资源。因此需要保证服务器物理内存是redis主进程所需内存的两倍，不然会使用虚拟内存，性能非常差

# AOF持久化

这种方式是以日志的形式记录服务器的每一写操作。**注重的是过程**。

## 配置

### 开启AOF

```
appendonly no   # 默认关闭，改为yes开启

appendfilename "appendonly.aof" # 文件名配置，目录与RDB一致
```

### 同步策略配置

```
# appendfsync always    #每修改同步（最安全但最慢）
appendfsync everysec    #每秒同步，默认使用这种
# appendfsync no    #不同步（最快但不安全）
```

**如果开启了AOF方式，重启redis时，数据都会通过aof文件加载**

注意：在操作系统中，文件写入的情况会先写入到系统的缓存中，系统每隔30秒（不同操作系统可能不一样）同步一次，才是真正写入到硬盘。如果在这30秒中，服务器挂了，数据也会丢失。

### 重写策略

可以使用`bgrewriteaof`命令来重写AOF文件。作用是去除中间的执行过程，保留最终数据的命令即可。

重写策略参数配置：

- auto-aof-rewrite-percentage 100
  + 当前AOF文件大小超过上一次重写时的文件大小的百分之多少时会再次重写，如果之前没有重写过，则以启动时的文件大小为依据
- auto-aof-rewrite-min-size 64mb
  + 限制允许重写的最小AOF文件大小。通常在文件很小的时候即使其中有些冗余的命令也是可以忽略的

## 优势

- 数据安全性高。redis提供了3种同步策略
    + 每秒同步。同步是异步完成的，其效率非常高，所差的是一旦崩溃了，那么这一秒的修改就会丢失。
    + 每修改同步。可以视为同步持久化，一旦数据发生修改，立即存储到硬盘，这种效率上是最低的。
    + 不同步。
- 由于日志文件写入操作是append模式，如果在写入过程中系统崩溃了，可能会破坏日志文件已存在的内容。然而，如果本次操作只写入了一半数据就崩溃了，在下次启动前，可以通过redis-check-aof工具来解决一致性问题
- 如果日志文件过大，redis会自动启用rewrite机制。及redis以append模式不断写入到旧文件中，同时还会创建一个新的文件用于记录此期间的操作。因此进行rewrite切换时可以更好的保证数据安全性

## 劣势

- 对于相同数量的数据，AOF文件通常大于RDB文件
- 根据同步策略的不同，AOF在运行效率上往往会慢于RDB
